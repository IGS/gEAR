<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Dataset comparison tool</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="-1">
        <meta http-equiv="CACHE-CONTROL" content="NO-CACHE">

        <!-- This is needed because mod_rewrite doesn't work well with relative paths.  This will need
             to be changed for any hosts where gEAR is not at the webserver root.
          -->
        <base href="/" />

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.3/css/bootstrap-select.min.css">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

        <!-- Interactive tree structure -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />

        <!-- Ensures we always get a new version (during our current active development cycles) -->
        <script>document.write('<link rel="stylesheet" href="css/common.' + (new Date()).getTime() + '.css" />');</script>
        <script>document.write('<link rel="stylesheet" href="css/compare_datasets.' + (new Date()).getTime() + '.css" />');</script>

        <script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
        <script src="https://cdn.plot.ly/plotly-1.54.1.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
 <div id="body_c">
    <div id="navigation_bar">
       <!-- content here inserted via JQuery -->
    </div> <!-- end navigation_bar -->

    <div id="main_content" class="container-fluid">
      <div class="row">
        <div class="col-12 alert-container">
	      <!-- CONTAINER FOR ALERTS - INSERTED BY JQUERY -->
        </div>
      </div>
      <div id='main_row' class="row">
        <div id="sidebar" class="col-2">
          <button type="button" class="btn btn-sm btn-outline-purple float-right position-relative" style="z-index: 1;" data-toggle="modal" data-target="#instructions_modal" id="instructions_btn">Click for Help</button>
          <div class="filter_block">
            <div class="form-group dropdown" id="dataset_c">
              <div id="pre_dataset_spinner" style="display:none;">
                <i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i>
                <span>Loading datasets...</span>
              </div>
              <div id="dataset_id" value="" data-title="Click to change" class="form-control form-control-sm text-truncate dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Choose dataset</div>
              <div class="dropdown-menu" aria-labelledby="dataset_id">
                <form class="px-4 py-3" onsubmit="return false;">
                  <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <i class="fa fa-search input-group-text" aria-hidden="true"></i>
                    </div>
                    <input type="text" class="form-control" id="dataset_tree_q" placeholder="Type to search datasets">
                  </div>
                  <div id="dataset_tree"></div>
                </form>
              </div>  <!-- end dropdown-menu -->
            </div>  <!-- end dataset_c -->
            <div class="form-group-sm">
              <ul class="nav nav-tabs" id="condition_tabs" role="tablist" style="display:none;">
                <li class="nav-item">
                  <a id="condition_x_tab" class="nav-link active" data-toggle="tab" href="#conditions_accordion" role="tab" aria-controls="conditions_accordion" aria-selected="true">X Condition</a>
                </li>
                <li class="nav-item">
                  <a id="condition_y_tab" class="nav-link" data-toggle="tab" href="#conditions_accordion" role="tab" aria-controls="conditions_accordion" aria-selected="false">Y Condition</a>
                </li>
              </ul>
            </div>

            <div class="form-group-sm alert alert-info" id="conditions_accordion">Select a dataset above to view groups.</div>
            <br />
            <div id="noncats"></div>
            <h3>Axis titles</h3>
            <small class="form-text text-muted">Customize the axes labels.</small>
            <div class="form-group-sm">
              <label for="x_label" class="control-label mb-0 mt-2">Adjust X Label</label>
              <input class="form-control form-control-sm" id="x_label" placeholder="Name of x-axis label">
            </div>
            <div class="form-group-sm">
              <label for="y_label" class="control-label mb-0 mt-2">Adjust Y Label</label>
              <input class="form-control form-control-sm" id="y_label" placeholder="Name of y-axis label">
            </div>
            <hr />
            <button id='btn_apply_dataset_changes' type="button" class="btn btn-default btn-sm center-block btn-apply-filter">Plot</button>
          </div>  <!-- end filter_block -->

          <div id="chart_settings">
            <h3>Data filters / settings</h3>
            <form>
              <div class="form-group-sm">
                <label for="log_base" class="control-label mb-0 mt-2">Apply log transformation</label>
                <select id="log_base" class="form-control form-control-sm">
                  <option value="raw">None - Raw values</option>
                  <option value="2" selected="selected">Log2</option>
                  <option value="10">Log10</option>
                </select>
              </div>
              <div class="form-group-sm">
                <label for="fold_change_cutoff" class="control-label mb-0 mt-2">Adjust fold change cutoff (>= N)</label>
                <input id="fold_change_cutoff" class="form-control form-control-sm" value="2.0"/>
              </div>
              <div class="form-group-sm">
                <label for="std_dev_num_cutoff" class="control-label mb-0 mt-2">Adjust standard deviation</label>
                <select id="std_dev_num_cutoff" class="form-control form-control-sm">
                  <option value="0" selected="selected">No filter</option>
                  <option value="1">1 standard deviation</option>
                  <option value="2">2 standard deviations</option>
                </select>
              </div>
            </form>
            <h3>Significance test</h3>
            <form>
              <div class="form-group-sm">
                <label id="statistical_test_label" for="statistical_test" class="control-label mb-0 mt-1">Select significance test</label>
                <select id="statistical_test" class="form-control form-control-sm">
                  <option value="" selected="selected">None</option>
                  <option value="t-test">T-test</option>
                  <option value="t-test_overestim_var">T-test (overestimated variance)</option>
                  <option value="wilcoxon">Wilcoxon-Rank-Sum</option>
                </select>
              </div>
              <div class="form-group-sm">
                <label for="test_pval_cutoff" class="control-label mb-0 mt-2">Adjust p-value cutoff</label>
                <input type="number" id="test_pval_cutoff" class="form-control form-control-sm" min=0 max=1.0 value=0.05 disabled/>
              </div>
              <div class="form-group-sm" id="stat_action_options_c">
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class="custom-control-input" value="colorize" id="stat_action_colorize" name="stat_action" checked>
                  <label class="custom-control-label" for="stat_action_colorize">Colorize</label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class="custom-control-input" value="filter" id="stat_action_filter" name="stat_action">
                  <label class="custom-control-label" for="stat_action_filter">Filter</label>
                </div>
              </div>
              <h3>Highlight genes</h3>
              <div class="form-group-sm">
                <input id="highlighted_genes" class="form-control form-control-sm" type="text" placeholder="comma-separated genes"/>
              </div>
              <div class="form-group-sm">
                <hr />
                <button id='btn_apply_dataset_changes2' type="button" class="btn btn-default btn-sm center-block btn-apply-filter">Plot</button>
              </div>
            </form>
            <ul>
              <li>Fold change std dev: <span id='fold_change_std_dev'></span></li>
            </ul>
          </div>
        </div> <!-- end #sidebar -->

        <div id="viewport" class="col-8">
          <div class="row">
            <div class="col-12">
              <div class='loading_indicator' id='plot_loading'>
                <img src='./img/loading_search.gif' alt='Loading' />
              </div>
              <h3 class='initial_instructions'>Instructions</h3>
              <div class='initial_instructions'>
                <p>
                  Choose a dataset and condition for each axis using the controls on the left.
                </p>
                <p>
                  For the x-axis and y-axis conditions, you are free to include and exclude any groups from the categorical observations. But if you are performing a significance test between then two conditions, then ensure that just a single differing group is chosen for each condition.
                </p>
                <p>
                  Some observation metadata may be listed as non-categorical, and will be excluded from consideration.  If some observations (such as sample ID or timepoint) are erroneously in this list, it may be because they were loaded in such a way that the dataframe reader interpreted them as continuous (numerical) datatypes.
                </p>
                <p>
                  <a href='./contact.html' class="text-primary">Feedback</a> on the dataset comparison tool is welcome.
                </p>
              </div>
              <div id='error_loading_c'>
                <p class="alert alert-danger">
                  There was a problem loading this comparison graph.  Please check the error message below and confirm plot selections are valid. If you need additional help, please
                  <a href='./contact.html' alt='Submit for help' class="text-primary alert-link">submit for help</a> with the
                  following information:
                </p>
                <div class="code">
                  <ul>
                    <li>Dataset ID: <span id='ticket_dataset_id'></span></li>
                    <li>Dataset Name: <span id='ticket_dataset_text'></span></li>
                    <li>Dataset X condition: <span id='ticket_datasetx_condition'></span></li>
                    <li>Dataset Y condition: <span id='ticket_datasety_condition'></span></li>
                    <li><strong>Error:</strong> <span id='ticket_error_msg'></span></li>
                  </ul>
                </div>
              </div> <!-- end #error_loading_c -->
              <div id='myChart'></div>
              <p id='genes_not_found' style="display:none;"></p>
            </div>
          </div>

          <div id="weighted_gene_cart_c" style="display:none;">
            <div class="form-group form-group-sm form-row">
              <label for="weighted_gene_cart_name col-1" class="control-label">Cart name to create:</label>
              <input class="form-control mb-1 mx-2 col-3" type="text" value="" id="weighted_gene_cart_name" />
              <div class="col-6">
                <label for="weighted_gene_cart_name" class="control-label">Fold-change:</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="foldchange_to_save" id="log-raw" value="1" checked>
                  <label class="form-check-label" for="log-raw">Raw</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="foldchange_to_save" id="log-2" value="2">
                  <label class="form-check-label" for="log-2">Log2</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="foldchange_to_save" id="log-10" value="10">
                  <label class="form-check-label" for="log-10">Log10</label>
                </div>
              </div>
            </div>

            <button id="save_weighted_gene_cart" class="btn btn-sm btn-purple">Save Weighted Gene Cart</button>
            <div id='saved_weighted_gene_cart_info_c' style="display:none;">
              <p class="status"></p>
              <div class="alert alert-danger alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <p class="message"></p>
              </div>
            </div>
          </div>

        </div> <!-- end #viewport -->
        <div id="docsbar" class="col-2">
          <div id="gene_list_c" class="row">
            <div class="col-12">
              <div id='controls_label'>
                <h3>Plot controls</h3>
              </div>
              <div id='selected_label'>
                <h3>Selected genes</h3>
                <div>
                  <button id="download_gene_table" type="button" class="btn btn-default" onclick="download_selected_genes();" aria-label="Download"
                          data-toggle="tooltip" data-placement="bottom" title="Download genes as a text file">
                    <span class="fa fa-download" aria-hidden="true"></span>
                  </button>
                  <button id="create_gene_cart" type="button" class="btn btn-default" aria-label="Create gene cart"
                          data-toggle="tooltip" data-placement="bottom" title="You must be logged in to create a gene cart" disabled>
                    <span class="fa fa-shopping-cart" aria-hidden="true"></span>
                  </button>
                </div>
                <div id='create_gene_cart_dialog'>
                  <div class="form-group-sm">
                    <label for="gene_cart_name" class="control-label">Cart name to create:</label>
                    <input class="form-control mb-1" type="text" value="" id="gene_cart_name" />
                  </div>
                  <div class="form-group-sm">
                    <button type="button" id="cancel_save_gene_cart" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="save_gene_cart" class="btn btn-primary" disabled>Save</button>
                  </div>
                </div>
                <div id='saved_gene_cart_info_c'>
                  <h3></h3>
                  <p id='saved_gene_cart_info'>
                    <span id='gene_cart_member_count'></span> genes saved into cart
                  </p>
                </div>
              </div>
              <div id='selection_methods_c' class='selection_instructions'>
                <p>
                  Hover over the plot and you'll see buttons on the right side, which control
                  actions like zooming and selection of points.
                </p>
                <dl>
                  <dt>Control icons</dt>
                  <dd>
                    <div><img class='img-fluid' src='img/instructions_comparison_controls.png' /></div>
                    The Box and Lasso selection tools allow you to click and drag a shape around
                    genes of interest.
                  </dd>
                  <dt>Selecting genes</dt>
                  <dd>
                    <div><img class='img-fluid' src='img/instructions_freeform_selection.png' /></div>
                    After you select your desired genes, a list of them all will
                    be displayed.
                  </dd>
                </dl>
              </div>
              <table id="tbl_selected_genes" class="table">
                <thead>
                  <tr>
                    <th onclick="sortTable(0);">Gene <i class="fa fa-sort" aria-hidden="true"></i></th>
                    <th onclick="sortTable(1);">FoldChg <i class="fa fa-sort" aria-hidden="true"></i></th>
                    <th onclick="sortTable(2);">Pval <i class="fa fa-sort" aria-hidden="true"></i></th>
                  </tr>
                <thead>
                  <tbody id='selected_genes_c'></tbody>
                  <script id="selected_genes_tmpl" type="text/x-jsrender">
                    <tr>
                      <td class="text-truncate">{{:gene_symbol}}</td>
                      <td>{{:foldchange}}</td>
                      <td>{{:pvals}}</td>
                    </tr>
                  </script>
              </table>
            </div>
          </div> <!-- end #gene_list_c -->
        </div><!-- end #docsbar -->
      </div><!-- end #main_row -->
    </div> <!-- end #main_content -->

    <footer>
      <div id='funding'>
        <!-- content here inserted via common.js -->
      </div>
    </footer>
  </div> <!-- /body_c -->

    <!-- Instructions modal -->
    <div class="modal fade" id="instructions_modal" tabindex="-1" role="dialog" aria-labelledby="instructions_label" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="instructions_label">Instructions</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <h3>Instructions</h3>
            <div>
              <p>
                Choose a dataset and condition for each axis using the controls on the left.
              </p>
              <p>
                For the x-axis and y-axis conditions, you are free to include and exclude any groups from the categorical observations. But if you are performing a significance test between then two conditions, then ensure that just a single differing group is chosen for each condition.
              </p>
              <p>
                Some observation metadata may be listed as non-categorical, and will be excluded from consideration.  If some observations (such as sample ID or timepoint) are erroneously in this list, it may be because they were loaded in such a way that the dataframe reader interpreted them as continuous (numerical) datatypes.
              </p>
              <p>
                <a href='./contact.html' class="text-primary">Feedback</a> on the dataset comparison tool is welcome.
              </p>
            </div>

            <h3>Plot controls</h3>
            <div>
              <p>
                Hover over the plot and you'll see buttons on the right side, which control
                actions like zooming and selection of points.
              </p>
              <dl>
                <dt>Control icons</dt>
                <dd>
                  <div><img class='img-fluid' src='img/instructions_comparison_controls.png' /></div>
                  The Box and Lasso selection tools allow you to click and drag a shape around
                  genes of interest.
                </dd>
                <dt>Selecting genes</dt>
                <dd>
                  <div><img class='img-fluid' src='img/instructions_freeform_selection.png' /></div>
                  After you select your desired genes, a list of them all will
                  be displayed.
                </dd>
              </dl>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-purple" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div> <!-- end save_genes_modal-->

  <!-- JSRender templates -->
  <script id="dataset_condition_options" type="text/x-jsrender">
    {{props itemVar="~category"}}
    {{!-- key is categorical observation, prop is the list of unique categories --}}
    <div class="card" id="{{:key}}_card" role="tabpanel">
      <div class="form-check form-check-inline">
        <input class="form-check-input js-cat-check" type="checkbox" value="" id="{{:key}}_check">
        <button id="{{:key}}_collapse" class="btn btn-light btn-sm btn-block js-cat-collapse" data-toggle="collapse" aria-expanded="true">
          {{:key}}
          <i class="fa fa-caret-down" aria-hidden="true"></i>
        </button>
      </div>
      <div id="{{:key}}_body" class="collapse" aria-labelledby="{{:key}}_card" data-parent="#conditions_accordion">
        <div class="card-body">
        {{props prop}}
          {{!-- key is list index, prop is the value --}}
          <div class="form-check">
            <label class="form-check-label"><input class="form-check-input js-group-check" type="checkbox" data-group="{{:~category.key}};-;{{:prop}}" value="">{{:prop}}</label>
          </div>
        {{/props}}
        </div>
      </div>
    </div>
    {{/props}}
  </script>

  <script id="non_categories_list" type="text/x-jsrender">
    <h5>Non-categorical observations excluded:</h5>
    <ul class="list-unstyled">
    {{for noncat_obs}}
      <li><small>{{:}}</small></li>
    {{/for}}
    </ul>
  </script>

        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.3/js/bootstrap-select.min.js"></script>

        <script src="js/vendor/js.cookie.js"></script>
        <script src="js/vendor/jsrender.20181003.min.js"></script>

        <!-- JStree -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

        <!-- Helps ensure the user gets the latest code, needed while we're pushing out so many updates -->
        <script>document.write('<script src="js/classes/user.' + (new Date()).getTime() + '.js"><\/script>');</script>
        <script>document.write('<script src="js/classes/gene.' + (new Date()).getTime() + '.js"><\/script>');</script>
        <script>document.write('<script src="js/classes/genecart.' + (new Date()).getTime() + '.js"><\/script>');</script>
        <script>document.write('<script src="js/classes/tree.' + (new Date()).getTime() + '.js"><\/script>');</script>
        <script>document.write('<script src="js/common.' + (new Date()).getTime() + '.js"><\/script>');</script>
        <script>document.write('<script src="js/compare_datasets.' + (new Date()).getTime() + '.js"><\/script>');</script>
    </body>
</html>
